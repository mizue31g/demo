**今回のCORSエラー修正で学んだこと**

**1. エラーの原因**
*   **バックエンド側のCORS設定の不備:**
    *   特定のオリジンからのアクセスが許可されていない。
    *   特定のHTTPメソッド（GET, POSTなど）やヘッダーが許可されていない。
    *   プリフライトリクエスト（OPTIONSメソッド）が正しく処理されていない。
*   **フロントエンド側のAPIエンドポイントの不一致:**
    *   フロントエンドが呼び出すAPIのURLパスが、バックエンドで定義されているルートと異なっている（例: `/generate_text` と `/api/generate_text`）。
    *   ベースURLの結合ミスにより、パスが重複している（例: `BACKEND_URL + path` が `/api/api/generate_text` となる）。
*   **環境変数 (VITE_BACKEND_URLなど) の誤った設定:**
    *   Viteなどのビルドツールを使用している場合、`VITE_`プレフィックスを持つ環境変数はビルド時に埋め込まれるため、Dockerの実行時環境変数とは異なる挙動を示す。
    *   ビルド時に環境変数が正しく注入されていない、または期待と異なる値が注入されている。

**2. 解決策**
*   **バックエンドCORS設定の確認と修正 (`backend/app.py`):**
    *   `Flask-CORS`ライブラリを使用している場合、`CORS(app, resources={r"/*": {"origins": "*"}}, supports_credentials=True)` のように、必要なオリジン、メソッド、ヘッダーを許可する設定が適切に行われているかを確認する。特に、プリフライトリクエストが正しく処理されることを確認する。
*   **フロントエンドAPIパスの整合性確認 (`frontend/services/geminiService.ts`):**
    *   `postApi`のような共通のAPI呼び出し関数でパスを結合する際、`BACKEND_URL`と`path`の双方に`/api`プレフィックスが重複して含まれていないかを確認する。
    *   最終的なAPI呼び出しURLが、バックエンドで定義されているルートと完全に一致することを確認する。
*   **ビルド環境変数 (VITE_BACKEND_URL) の正しい注入方法:**
    *   Viteアプリケーションの場合、`Dockerfile`内で`npm run build`を実行する際に、`sh -c "VITE_BACKEND_URL=${VITE_BACKEND_URL} npm run build"` のようにして、ビルド環境に明示的に環境変数を渡す。
    *   `cloudbuild.yaml`を使用する場合、`--build-arg`や`substitutions`を適切に利用するが、その挙動が複雑な場合があるため、動作確認を徹底する。
    *   **一時的な回避策:** 問題が解決しない場合、`Dockerfile`内で環境変数を直接ハードコードし、`cloudbuild.yaml`を一時的に無効化（削除）してビルド・デプロイを試みる。問題解決後、この変更は必ず元に戻す。

**3. 今後の再発防止策**
*   **厳密なAPIパスの定義:** フロントエンドとバックエンド間でAPIパスの命名規則を統一し、変更があった場合は両者の整合性を常に確認する。
*   **環境変数のテスト:** デプロイ前のテスト段階で、開発環境と本番環境で環境変数が期待通りにロードされているかを確認する仕組みを導入する。
*   **CORS設定のドキュメント化:** バックエンドのCORS設定の意図と詳細を明確にドキュメント化し、変更時にはその影響を考慮する。
*   **デバッグ手順の標準化:** CORSエラーが発生した場合の標準的なデバッグ手順（ブラウザのコンソール確認、ネットワークタブ確認、バックエンドログ確認など）を確立する。
